<html>
    <head>
        <meta charset="utf-8">
        <link rel="icon" href="favicon.png" type="image/png">

        <title>ADIP</title>

        <link rel="stylesheet" href="css/style.css">

        <script src="js/InpaintJS.js"></script>
        <script src="js/taskBoard.js"></script>
        <script src="js/perfManager.js"></script>
    </head>
    <body>
        <div style="height:100%;width:100%;display:flex;flex-direction: column;align-items: center;">
            <span id="opencv-info">openCV.js 還沒準備好</span>
            <div id="image-editor-canvas-div" style="position: relative; max-height: 90%;max-width:90%;">
                <canvas id="image-editor-canvas" style="max-height: 100%;max-width:100%;"></canvas>
                <canvas id="image-editor-mask-canvas" style="position: absolute;top: 0;left: 0;max-height: 100%;max-width:100%;"></canvas>
            </div>
            <div>
                <span onclick="
                        if(image_editor_mask_canvas.style.display!='none'){
                            image_editor_mask_canvas.style.display='none';
                            this.innerHTML='顯示遮罩';
                        }else{
                            image_editor_mask_canvas.style.display='block';
                            this.innerHTML='隱藏遮罩';
                        }
                    " style="text-decoration: underline;cursor: pointer;">隱藏遮罩</span>
            </div>
            <div>
                <div id="GrabCut-menu" style="display:none;">
                    <button onclick="
                            image_editing_data.grabCutFirst=false;
                            const ctx=image_editor_mask_canvas.getContext('2d');
                            ctx.clearRect(0, 0, image_editor_mask_canvas.width, image_editor_mask_canvas.height);
                            opencv_info.innerHTML='選擇一個區塊來計算物件';
                        ">重製遮罩</button>
                    <button onclick="
                            image_editing_data.grabCutFirst=true;
                            image_editing_data.grabCutAdd=1;
                            opencv_info.innerHTML='標記想要添加的部分';
                        ">添加區域</button>
                    <button onclick="
                            image_editing_data.grabCutAdd=2;
                            opencv_info.innerHTML='標記想要移除的部分';
                        ">去除區域</button>
                    <br>
                    筆刷大小: <input type="number" onchange="updatePenWidth(parseInt(this.value));" min="1" max="50" value="5" class="pen-width">
                    <button onclick="saveGrabCut();">儲存影像</button>
                </div>
                <div id="Merge-menu" style="display:none;">
                    <select id="merge-layer-select"></select>
                    <button onclick="
                            if(image_editing_data.layer){
                                if(image_editing_data.select<image_editing_data.layer.length-1){
                                    moveItemInArray(image_editing_data.layer, image_editing_data.select, image_editing_data.select+1);
                                    moveItemInArray(image_editing_data.adjust, image_editing_data.select, image_editing_data.select+1);
                                    updateMergeLayerSelect();
                                    drawMergeImage();
                                }
                            }
                        ">&uarr;</button>
                    <button onclick="
                            if(image_editing_data.layer){
                                if(image_editing_data.select>0) {
                                    moveItemInArray(image_editing_data.layer, image_editing_data.select, image_editing_data.select-1);
                                    moveItemInArray(image_editing_data.adjust, image_editing_data.select, image_editing_data.select-1);
                                    updateMergeLayerSelect();
                                    drawMergeImage();
                                }
                            }
                        ">&darr;</button>
                    <button onclick="
                            if(image_editing_data.layer){
                                if(confirm('更換基底將重製畫面，確認更換?')) changeMergeBase(image_editing_data.select);
                            }
                        ">設為基底</button>
                    <button onclick="
                            if(image_editing_data.layer){
                                if(confirm(`確認刪除: ${image_editing_data.layer[image_editing_data.select].name}?`)){
                                    removeMergeLayer(image_editing_data.select);
                                }
                            }
                        ">刪除層</button>
                    <br>
                    <button onclick="mirrorMergeImage(image_editing_data.select, 0);">水平鏡像</button>
                    <button onclick="mirrorMergeImage(image_editing_data.select, 1);">垂直鏡像</button>
                    旋轉:<input id="image-rotate" type="range" min="-180" max="180" value="0" oninput="
                            rotateMergeImage(image_editing_data.select, parseInt(this.value));
                        ">
                    <br>
                    <button onclick="applyGrayWorldWhiteBalance(image_editing_data.select);">白平衡(灰色世界)</button>
                    <button onclick="applyGrayEdgeWhiteBalance(image_editing_data.select);">白平衡(灰色邊緣)</button>
                    <button onclick="applyRobustWhitePatchWhiteBalance(image_editing_data.select);">白平衡(白斑)</button>
                    <button onclick="
                        if(0<=image_editing_data.select&&image_editing_data.select<image_editing_data.layer.length){
                            if(image_editing_data.layer.length<=1){
                                alert('找不到其他來源!');
                            }else if(image_editing_data.layer.length<=2){
                                colorMatch((image_editing_data.select+1)%2, image_editing_data.select);
                            }else{
                                let ret=parseInt(prompt(`請選擇轉移來源:\n${image_editing_data.layer.filter((v, i)=>(i!=image_editing_data.select)).map((v, i)=>((i+1).toString()+': '+v.name)).join('\n')}`))-1;
                                if(0<=ret&&ret<image_editing_data.layer.length-1){
                                    ret=ret<image_editing_data.select?ret:ret+1;
                                    colorMatch(ret, image_editing_data.select);
                                }
                            }
                        }
                    ">轉移顏色</button>
                    <br>
                    轉移顏色占比: <input type="range" id="harm-strength" min="0" max="100" value="80" 
                            oninput="handleHarmonization()" style="vertical-align: middle;">
                        <span id="strength-val">80%</span>
                    <br>
                    <span style="text-decoration: underline;cursor: pointer;" onclick="
                            const color_ctrl=document.getElementById('color-ctrl');
                            if(!color_ctrl.style.display||color_ctrl.style.display=='none')
                                color_ctrl.style.display='block';
                            else
                                color_ctrl.style.display='none';
                        ">顏色細調</span>
                    <div id="color-ctrl" style="display: none;">
                        色溫: <input type="range" id="adj-temp" min="0" max="100" value="50" 
                                oninput="handleImageAdjustments()" style="vertical-align: middle;">
                        <span id="val-temp">50</span>
                        <br>
                        色調: <input type="range" id="adj-tint" min="0" max="100" value="50" 
                            oninput="handleImageAdjustments()" style="vertical-align: middle;">
                        <span id="val-tint">50</span>
                        <br>
                        亮度: <input type="range" id="adj-bright" min="0" max="100" value="50" 
                                oninput="handleImageAdjustments()" style="vertical-align: middle;">
                        <span id="val-bright">50</span>
                        <br>
                        對比: <input type="range" id="adj-contrast" min="0" max="100" value="50" 
                                oninput="handleImageAdjustments()" style="vertical-align: middle;">
                        <span id="val-contrast">50</span>
                        <br>
                        飽和: <input type="range" id="adj-sat" min="0" max="100" value="50" 
                            oninput="handleImageAdjustments()" style="vertical-align: middle;">
                        <span id="val-sat">50</span>
                    </div>
                    <br>
                    陰影: <input type="checkbox" id="shadow-enable" onchange="
                            if(this.checked){
                                image_editing_data.shadow={
                                    angle:90,
                                    length:1,
                                    decay:0.5,
                                };
                            }else{
                                image_editing_data.shadow=null;
                            }
                            drawMergeImage();
                        ">
                    <br>
                    陰影角度: <input type="range" id="shadow-angle" oninput="if(image_editing_data.shadow){image_editing_data.shadow.angle=(parseFloat(this.value)+450)%360;drawMergeImage();}" min="-180" max="180" value="0">
                    <br>
                    陰影長度: <input type="range" id="shadow-length" oninput="if(image_editing_data.shadow){image_editing_data.shadow.length=parseFloat(this.value);drawMergeImage();}" min="0.1" max="10" value="0.5" step="0.1">
                    <br>
                    陰影衰減: <input type="range" id="shadow-decay" oninput="if(image_editing_data.shadow){image_editing_data.shadow.decay=parseFloat(this.value);drawMergeImage();}" min="0" max="1" value="0.5" step="0.1">
                    <br>
                    <button onclick="resetMergeImage(image_editing_data.select);">重置圖片</button>
                    <button onclick="saveMergeImage();">儲存影像</button>
                </div>
                <div id="PhotoFix-menu" style="display:none;">
                    筆刷大小: <input type="number" onchange="updatePenWidth(parseInt(this.value));" min="1" max="50" value="5" class="pen-width">
                    <button onclick="fixImage();">修補影像</button>
                    <button onclick="fixImagePatchMatch();">修補影像(PM)</button>
                    <button onclick="saveFixImage();">儲存影像</button>
                </div>
                <div id="Relight-menu" style="display:none;">
                    光源距離: <input id="relight-z" type="range" onchange="image_editing_data.z=parseFloat(this.value);updateRelightData();" min="10" max="200" value="100" step="0.1"><br>
                    光源大小: <input id="relight-range" type="range" onchange="image_editing_data.range=parseFloat(this.value);updateRelightData();" min="10" max="1000" value="500" step="0.1"><br>
                    強度: <input id="relight-intensity" type="range" onchange="image_editing_data.intensity=parseFloat(this.value);updateRelightData();" min="0" max="5" value="1" step="0.1"><br>
                    陰影強度: <input id="relight-shadowIntensity" type="range" onchange="image_editing_data.shadowIntensity=parseFloat(this.value);updateRelightData();" min="0" max="5" value="1" step="0.1"><br>
                    光滑度: <input id="relight-smooth" type="range" onchange="image_editing_data.smoothness=parseFloat(this.value);updateRelightData();" min="9" max="101" value="51" step="2"><br>
                    Half Lambert: <input id="relight-half" type="checkbox" onchange="image_editing_data.half=this.checked;updateRelightData();">
                    <button onclick="saveRelightImage();">儲存影像</button>
                    <br>
                    <button onclick="saveNormalMapImage();">儲存向量圖</button>
                </div>
            </div>
            <div style="margin-bottom: 25px;">
                <button onclick="setEditImage(null, 'NOPE');">清除圖像</button>
            </div>
            
            <div>
                <input id="image-input" type="file" accept="image/*" multiple disabled>
                <button id="image-example-btn" onclick="loadExample();" disabled>Load Example</button>
            </div>
            <div id="preview-image" style="width:100%;display:flex;flex-wrap: wrap;justify-content: center;align-content: flex-start;background:#f0f0f0;">
            </div>
        </div>

        <div style="position: fixed;top: 0;left: 0;height:50%;max-width:50%;">
            <div id="perf-board-button" style="position: absolute;top: 0;left: 0;height:30px;width: 50px; background: #f0f0a0;border: 2px solid black;display: flex;justify-content: center;align-items: center;cursor: pointer;">PERF</div>
            <div id="perf-board-clear-button" style="position: absolute;top: 0;left: 55;height:30px;width: 50px; background: #f0a0a0;border: 2px solid black;display: none;justify-content: center;align-items: center;cursor: pointer;">CLEAR</div>
            <div id="perf-board" style="display:none;max-height:100%;max-width:100%;min-height:100px;min-width:200px;background: #f0f0f0;border: 2px solid black;overflow-x:inherit;overflow-y: scroll;padding: 35px 5px 5px 5px;"></div>
        </div>

        <div style="position: fixed;top: 0;right: 0;height:50%;max-width:50%;">
            <div id="task-board-button" style="position: absolute;top: 0;right: 0;height:30px;width: 50px; background: #f0a0a0;border: 2px solid black;display: flex;justify-content: center;align-items: center;cursor: pointer;">TASK</div>
            <div id="task-board" style="display:none;max-height:100%;max-width:100%;min-height:100px;min-width:200px;background: #f0f0f0;border: 2px solid black;overflow-x:inherit;overflow-y: scroll;padding: 35px 5px 5px 5px;"></div>
        </div>

        <div id="memory-use" style="position: fixed;bottom: 0;right: 0; background: #a0f0a0;border: 2px solid black;display: flex;justify-content: center;align-items: center;cursor: pointer;">0/0</div>

        <script src="js/image_editor.js"></script>
        <script src="js/main.js"></script>
        <script async src="js/opencv.js" onload="openCVReady();"></script>
    </body>
</html>